<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Stripe - Garcia Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <style>
        body {
            background: linear-gradient(135deg, #0a0f1e 0%, #1a2449 100%);
            color: white;
            padding: 2rem 0;
        }
        .test-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(246, 200, 78, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
        }
        .price-display {
            font-size: 2rem;
            color: var(--gold, #f6c84e);
            font-weight: bold;
        }
        .price-id {
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 0.5rem;
            border-radius: 5px;
            margin: 0.5rem 0;
            font-size: 0.8rem;
        }
        .btn-test {
            background: linear-gradient(135deg, var(--gold, #f6c84e), #ffd700);
            color: #0a0f1e;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(246, 200, 78, 0.3);
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .status-success { background: rgba(40, 167, 69, 0.2); border: 1px solid #28a745; }
        .status-error { background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; }
        .status-warning { background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="title-gradient">Teste do Sistema Stripe</h1>
            <p class="subtitle">Verificando configura√ß√µes e testando pagamentos</p>
        </div>

        <!-- Status do Sistema -->
        <div class="row">
            <div class="col-12">
                <div class="test-card">
                    <h3>üìä Status do Sistema</h3>
                    <div id="systemStatus">
                        <div class="status status-warning">
                            ‚è≥ Verificando configura√ß√µes...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teste dos Planos -->
        <div class="row">
            <div class="col-12">
                <div class="test-card">
                    <h3>üí∞ Planos Configurados</h3>
                    <div id="plansTest">
                        <div class="status status-warning">
                            ‚è≥ Carregando planos...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teste de Pagamento -->
        <div class="row">
            <div class="col-12">
                <div class="test-card">
                    <h3>üß™ Teste de Pagamento (Starter Plan)</h3>
                    <p>Use dados de teste do Stripe:</p>
                    <ul>
                        <li><strong>Cart√£o:</strong> 4242 4242 4242 4242</li>
                        <li><strong>Expira√ß√£o:</strong> qualquer data futura</li>
                        <li><strong>CVC:</strong> qualquer 3 d√≠gitos</li>
                        <li><strong>CEP:</strong> qualquer c√≥digo</li>
                    </ul>
                    <div class="d-flex justify-content-center mt-4">
                        <button id="testPaymentBtn" class="btn-test" onclick="testPayment()">
                            üöÄ Testar Pagamento Starter (¬£75)
                        </button>
                    </div>
                    <div id="paymentStatus" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="js/stripe-config.js"></script>
    <script>
        // Verificar configura√ß√µes
        async function checkSystem() {
            const statusDiv = document.getElementById('systemStatus');
            const plansDiv = document.getElementById('plansTest');

            try {
                // Verificar se as configura√ß√µes foram carregadas
                if (typeof window.STRIPE_ENV_CONFIG === 'undefined') {
                    throw new Error('Configura√ß√µes Stripe n√£o carregadas');
                }

                const config = window.STRIPE_ENV_CONFIG;

                // Verificar servidor
                const serverResponse = await fetch(`${config.apiUrl}/health`);
                if (!serverResponse.ok) {
                    throw new Error('Servidor n√£o est√° respondendo');
                }

                // Status do sistema
                statusDiv.innerHTML = `
                    <div class="status status-success">
                        ‚úÖ <strong>Sistema OK!</strong><br>
                        üîë Publishable Key: ${config.publishableKey.substring(0, 20)}...<br>
                        üåê API URL: ${config.apiUrl}<br>
                        üñ•Ô∏è Servidor: Funcionando
                    </div>
                `;

                // Mostrar planos
                let plansHtml = '<div class="status status-success">‚úÖ <strong>Planos Configurados:</strong></div>';
                const plans = [
                    { name: 'Starter', price: '¬£75', id: config.priceIds.starter },
                    { name: 'Beginner', price: '¬£95', id: config.priceIds.beginner },
                    { name: 'Essentials', price: '¬£115', id: config.priceIds.essentials },
                    { name: 'Full', price: '¬£155', id: config.priceIds.full },
                    { name: 'Elite', price: '¬£230', id: config.priceIds.elite }
                ];

                plans.forEach(plan => {
                    plansHtml += `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>${plan.name}</strong> - <span class="price-display">${plan.price}</span>
                            </div>
                            <div class="price-id">${plan.id}</div>
                        </div>
                    `;
                });

                plansDiv.innerHTML = plansHtml;

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status status-error">
                        ‚ùå <strong>Erro:</strong> ${error.message}
                    </div>
                `;

                plansDiv.innerHTML = `
                    <div class="status status-error">
                        ‚ùå <strong>N√£o foi poss√≠vel carregar os planos</strong>
                    </div>
                `;
            }
        }

        // Testar pagamento
        async function testPayment() {
            const btn = document.getElementById('testPaymentBtn');
            const statusDiv = document.getElementById('paymentStatus');

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Processando...';

            try {
                const config = window.STRIPE_ENV_CONFIG;
                const stripe = Stripe(config.publishableKey);

                // Criar sess√£o de checkout
                const response = await fetch(`${config.apiUrl}/create-checkout-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: config.priceIds.starter,
                        planName: 'Starter - Garcia Builder',
                        userEmail: 'teste@garciabuildre.com'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro na cria√ß√£o da sess√£o');
                }

                const { sessionId } = await response.json();

                // Redirecionar para o checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: sessionId
                });

                if (result.error) {
                    throw new Error(result.error.message);
                }

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status status-error">
                        ‚ùå <strong>Erro no pagamento:</strong> ${error.message}
                    </div>
                `;

                btn.disabled = false;
                btn.innerHTML = 'üöÄ Testar Pagamento Starter (¬£75)';
            }
        }

        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', () => {
            setTimeout(checkSystem, 500);
        });
    </script>
</body>
</html>
