<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Teste Stripe Simples</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f0f0f0; }
        .test-card { background: white; padding: 30px; border-radius: 10px; margin: 20px 0; }
        .test-btn { background: #6772e5; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 10px; font-size: 16px; }
        .test-btn:hover { background: #5469d4; }
        .test-btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>🧪 Teste Simples do Stripe</h1>
        <p>Teste direto da integração com chaves de teste</p>

        <div id="status" class="status info">Pronto para testar...</div>

        <button class="test-btn" onclick="testarPagamento('starter', 'Starter Plan')">
            🚀 Testar Starter - £75/mês
        </button>

        <button class="test-btn" onclick="testarPagamento('essentials', 'Essentials Plan')">
            ⭐ Testar Essentials - £115/mês
        </button>
    </div>

    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        const statusDiv = document.getElementById('status');

        // Inicializar Stripe com chave de teste pública
        const stripe = Stripe('pk_test_TYooMQauvdEDq54NiTphI7jx');

        async function testarPagamento(planKey, planName) {
            try {
                statusDiv.className = 'status info';
                statusDiv.textContent = `🔄 Criando sessão para ${planName}...`;

                // Desabilitar todos os botões durante o teste
                document.querySelectorAll('.test-btn').forEach(btn => btn.disabled = true);

                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        planKey: planKey,
                        planName: planName,
                        customerEmail: 'test@example.com',
                        successUrl: window.location.origin + '/success.html',
                        cancelUrl: window.location.href
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const sessionData = await response.json();

                statusDiv.className = 'status success';
                statusDiv.textContent = `✅ Sessão criada! Redirecionando para Stripe...`;

                // Redirecionar para Stripe Checkout
                const { error } = await stripe.redirectToCheckout({
                    sessionId: sessionData.sessionId
                });

                if (error) {
                    throw error;
                }

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ Erro: ${error.message}`;
                console.error('Erro detalhado:', error);

                // Reabilitar botões em caso de erro
                document.querySelectorAll('.test-btn').forEach(btn => btn.disabled = false);
            }
        }
    </script>
</body>
</html>
