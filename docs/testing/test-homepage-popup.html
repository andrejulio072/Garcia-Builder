<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Exit Intent - Homepage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/components/newsletter.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            min-height: 200vh;
            padding: 20px;
        }
        .test-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #F6C84E;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: sticky;
            top: 20px;
            z-index: 1000;
        }
        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-ok { border-left: 4px solid #28a745; }
        .status-blocked { border-left: 4px solid #dc3545; }
        .status-pending { border-left: 4px solid #ffc107; }
        .test-btn {
            background: linear-gradient(135deg, #F6C84E, #f39c12);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
        .content-section {
            margin: 40px 0;
            padding: 40px;
            border: 1px dashed rgba(246, 200, 78, 0.3);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-home"></i> Teste Exit Intent - Homepage</h1>

        <div class="test-panel">
            <h3><i class="fas fa-chart-line"></i> Status do Popup</h3>
            <div id="statusContainer">
                <div class="status-item status-pending">
                    <span>Sistema carregando...</span>
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>

            <hr>

            <h4><i class="fas fa-tools"></i> Controles de Teste</h4>
            <button class="test-btn" onclick="checkStatus()">
                <i class="fas fa-check"></i> Verificar Status
            </button>
            <button class="test-btn" onclick="triggerExitIntent()">
                <i class="fas fa-mouse-pointer"></i> Simular Exit Intent
            </button>
            <button class="test-btn" onclick="resetSession()">
                <i class="fas fa-redo"></i> Reset Sessão (Teste)
            </button>
            <button class="test-btn" onclick="triggerLeadMagnet()">
                <i class="fas fa-magnet"></i> Link Lead Magnet
            </button>

            <hr>

            <h4><i class="fas fa-info-circle"></i> Como Testar</h4>
            <ol>
                <li><strong>Verificar Status:</strong> Confirme que está na homepage</li>
                <li><strong>Trigger Exit:</strong> Mova mouse para fora da tela (topo)</li>
                <li><strong>Fechar Popup:</strong> Clique no X ou fora do popup</li>
                <li><strong>Verificar Bloqueio:</strong> Tente trigger novamente</li>
                <li><strong>Reset:</strong> Reabra o site para ver popup novamente</li>
            </ol>
        </div>

        <div class="content-section">
            <h2>📍 Esta é a Homepage</h2>
            <p>O popup de exit intent deve funcionar apenas aqui.</p>
        </div>

        <div class="content-section">
            <h2>🖱️ Teste Exit Intent</h2>
            <p>Mova o mouse rapidamente para fora da tela (pela parte superior).</p>
        </div>

        <div class="content-section">
            <h2>📱 Teste Mobile Scroll</h2>
            <p>Em dispositivos móveis, role até 60% da página.</p>
        </div>

        <div class="content-section">
            <h2>🔒 Teste de Sessão</h2>
            <p>Após fechar o popup, ele não deve aparecer novamente até reabrir o site.</p>
        </div>
    </div>

    <!-- Newsletter System -->
    <script>
        // Mock Supabase for testing
        window.supabaseClient = {
            from: () => ({
                insert: () => Promise.resolve({ error: null })
            })
        };
    </script>
    <script src="js/components/newsletter-manager.js"></script>

    <script>
        let statusInterval;

        function updateStatus() {
            if (!window.GarciaNewsletterSystem) {
                document.getElementById('statusContainer').innerHTML = `
                    <div class="status-item status-blocked">
                        <span>Sistema não carregado</span>
                        <i class="fas fa-times"></i>
                    </div>
                `;
                return;
            }

            const status = window.GarciaNewsletterSystem.checkPopupStatus();
            const isSessionSuppressed = sessionStorage.getItem('gb_exit_intent_shown_session') === '1';
            const popupExists = !!document.querySelector('.exit-intent-overlay');

            document.getElementById('statusContainer').innerHTML = `
                <div class="status-item ${status.isHomePage ? 'status-ok' : 'status-blocked'}">
                    <span>Homepage detectada</span>
                    <i class="fas fa-${status.isHomePage ? 'check' : 'times'}"></i>
                </div>
                <div class="status-item ${!isSessionSuppressed ? 'status-ok' : 'status-blocked'}">
                    <span>Popup disponível</span>
                    <i class="fas fa-${!isSessionSuppressed ? 'check' : 'times'}"></i>
                </div>
                <div class="status-item ${popupExists ? 'status-pending' : 'status-ok'}">
                    <span>Popup ${popupExists ? 'visível' : 'oculto'}</span>
                    <i class="fas fa-${popupExists ? 'eye' : 'eye-slash'}"></i>
                </div>
                <div class="status-item status-pending">
                    <span>Caminho: ${status.currentPath}</span>
                    <small style="opacity: 0.7;">Path atual</small>
                </div>
            `;
        }

        function checkStatus() {
            if (window.GarciaNewsletterSystem) {
                window.GarciaNewsletterSystem.checkPopupStatus();
            }
            updateStatus();
        }

        function triggerExitIntent() {
            // Simulate mouse leave event
            const event = new MouseEvent('mouseleave', {
                clientY: -10,
                bubbles: true
            });
            document.dispatchEvent(event);

            setTimeout(updateStatus, 500);
        }

        function resetSession() {
            if (window.GarciaNewsletterSystem) {
                window.GarciaNewsletterSystem.resetPopupSession();
            }
            updateStatus();
        }

        function triggerLeadMagnet() {
            // Create temporary trigger
            const trigger = document.createElement('a');
            trigger.setAttribute('data-open-lead-magnet', 'true');
            trigger.style.display = 'none';
            document.body.appendChild(trigger);
            trigger.click();
            trigger.remove();

            setTimeout(updateStatus, 500);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus();
            statusInterval = setInterval(updateStatus, 2000); // Update every 2 seconds
        });

        // Listen for popup events
        document.addEventListener('click', (e) => {
            if (e.target.matches('.exit-intent-close, .exit-intent-overlay')) {
                setTimeout(updateStatus, 100);
            }
        });

        // Console helper
        console.log(`
🧪 COMANDOS DE TESTE DISPONÍVEIS:

checkStatus()           - Verificar status atual
triggerExitIntent()     - Simular exit intent
resetSession()          - Resetar sessão do popup
triggerLeadMagnet()     - Trigger manual

📊 VERIFICAÇÃO DE STATUS:
window.GarciaNewsletterSystem.checkPopupStatus()
window.GarciaNewsletterSystem.resetPopupSession()
        `);
    </script>
</body>
</html>
