<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="auth.forgot_password_title">Forgot Password - Garcia Builder</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../css/global.css?v=20251003-2030">
    <link rel="stylesheet" href="../../css/pages/auth.css?v=20251003-2030">
    <link rel="stylesheet" href="../../css/layout-fixes.css?v=20251003-2030">
    <link rel="preload" as="script" href="../../js/utils/component-loader-v3-simplified.js?v=20251029" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="../../components/navbar.html" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="../../components/footer.html" crossorigin="anonymous">
    <link rel="stylesheet" href="../../css/components/navbar-component.css?v=20251028">
    <link rel="stylesheet" href="../../css/components/enhanced-navbar.css?v=20251025">
    <link rel="stylesheet" href="../../css/components/newsletter.css?v=20251025">

    <!-- Mobile safe overrides -->
    <style id="mobile-safe-overrides">
        html, body { max-width: 100%; overflow-x: hidden; }
        img { max-width: 100%; height: auto; display: block; }
        @media (max-width: 575.98px) {
            .container, .container.inner { padding-left: 16px; padding-right: 16px; }
            .auth-card { margin: 1rem; padding: 1.5rem; }
        }
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
        }
    </style>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body class="auth-page">
    <div data-component="navbar"></div>

    <!-- Main Content -->
    <div class="auth-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="auth-card glass-effect">
                        <div class="text-center mb-4">
                            <div class="auth-icon">
                                <i class="fas fa-key"></i>
                            </div>
                            <h2 data-i18n="auth.forgot_password_title">Forgot Password</h2>
                            <p class="text-muted" data-i18n="auth.forgot_password_subtitle">
                                Enter your email address and we'll send you a link to reset your password.
                            </p>
                        </div>

                        <form id="forgot-password-form">
                            <div class="mb-3">
                                <label for="email" class="form-label" data-i18n="auth.email">Email Address</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                    <input
                                        type="email"
                                        class="form-control"
                                        id="email"
                                        name="email"
                                        data-i18n-placeholder="auth.email_placeholder"
                                        placeholder="your@email.com"
                                        required
                                        autocomplete="email"
                                    >
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mb-3" id="submit-btn">
                                <i class="fas fa-paper-plane me-2"></i>
                                <span data-i18n="auth.send_reset_link">Send Reset Link</span>
                            </button>

                            <div class="text-center">
                                <a href="login.html" class="text-decoration-none" data-i18n="auth.back_to_login">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Login
                                </a>
                            </div>
                        </form>

                        <!-- Success/Error Messages -->
                        <div id="message" class="alert d-none mt-3" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/core/supabase.js"></script>
    <script src="../../js/utils/component-loader-v3-simplified.js?v=20251029"></script>
    <script src="../../js/core/i18n-shim.js" defer></script>
    <script src="../../assets/i18n.js?v=20251027" defer></script>
    <script src="../../js/core/auth.js" defer></script>
    <script src="../../js/core/auth-guard.js?v=20251009" defer></script>
    <script src="../../js/tracking/conversion-helper.js" defer></script>

    <script>
        const translate = (key, fallback) => {
            try {
                const api = window.GBi18n;
                if (api && typeof api.t === 'function') {
                    const value = api.t(key);
                    if (typeof value === 'string' && value.trim()) {
                        return value;
                    }
                }
            } catch (err) {
                console.warn('i18n lookup failed for', key, err);
            }
            return fallback;
        };

        const formatMessage = (template, replacements = {}) => {
            if (typeof template !== 'string') {
                return '';
            }
            return template.replace(/\{(\w+)\}/g, (_, token) => {
                return Object.prototype.hasOwnProperty.call(replacements, token) ? replacements[token] : `{${token}}`;
            });
        };

        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            if (!messageDiv) return;

            const variant = type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info';
            messageDiv.className = `alert alert-${variant}`;
            messageDiv.textContent = text;
            messageDiv.classList.remove('d-none');

            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('d-none');
                }, 5000);
            }
        }

        const computeSiteBaseUrl = () => {
            if (window.__ENV && typeof window.__ENV.PUBLIC_SITE_URL === 'string' && window.__ENV.PUBLIC_SITE_URL) {
                return window.__ENV.PUBLIC_SITE_URL.replace(/\/$/, '');
            }

            try {
                const { origin, pathname } = window.location;
                const segments = (pathname || '/').split('/').filter(Boolean);
                const pagesIdx = segments.indexOf('pages');
                let baseSegments;
                if (pagesIdx > -1) {
                    baseSegments = segments.slice(0, pagesIdx);
                } else if (segments.length > 0) {
                    baseSegments = segments.slice(0, segments.length - 1);
                } else {
                    baseSegments = [];
                }
                const basePath = baseSegments.length ? `/${baseSegments.join('/')}` : '';
                const base = `${origin}${basePath}`.replace(/\/$/, '');
                if (!window.__ENV) window.__ENV = {};
                if (!window.__ENV.PUBLIC_SITE_URL) {
                    window.__ENV.PUBLIC_SITE_URL = base;
                }
                return base;
            } catch (err) {
                console.warn('computeSiteBaseUrl fallback used for reset redirect:', err);
                return (window.location && window.location.origin ? window.location.origin : '').replace(/\/$/, '');
            }
        };

        const getLocalDevBase = () => {
            const saved = (localStorage.getItem('gb_local_base') || '').trim();
            if (saved) return saved;
            if (/^https?:\/\//i.test(window.location.origin)) {
                return window.location.origin;
            }
            return 'http://localhost:5500';
        };

        const buildResetRedirectUrl = () => {
            const hostedBase = (window.__ENV && window.__ENV.PUBLIC_SITE_URL)
                ? window.__ENV.PUBLIC_SITE_URL.replace(/\/$/, '')
                : 'https://garciabuilder.fitness';

            if (window.location.protocol === 'file:') {
                const localBase = getLocalDevBase().replace(/\/$/, '');
                try {
                    const url = new URL('pages/auth/reset-password.html', `${hostedBase}/`);
                    url.searchParams.set('devReturn', localBase);
                    return url.toString();
                } catch (err) {
                    console.warn('Failed to build hosted reset redirect URL (file:// mode). Falling back to hosted root.', err);
                    return `${hostedBase}/pages/auth/reset-password.html`;
                }
            }

            const base = computeSiteBaseUrl();
            try {
                const url = new URL('pages/auth/reset-password.html', `${base}/`);
                if (/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname)) {
                    url.searchParams.set('devReturn', base);
                }
                return url.toString();
            } catch (err) {
                console.warn('Failed to build reset redirect URL. Falling back to origin path.', err);
                return `${window.location.origin.replace(/\/$/, '')}/pages/auth/reset-password.html`;
            }
        };

        const forgotForm = document.getElementById('forgot-password-form');
        if (forgotForm) {
            forgotForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const submitBtn = document.getElementById('submit-btn');
                const emailField = document.getElementById('email');
                const email = emailField ? emailField.value.trim() : '';

                if (!email) {
                    showMessage(translate('auth.forgot_email_required', 'Please enter your email address.'), 'error');
                    return;
                }

                const originalHTML = submitBtn ? submitBtn.innerHTML : '';
                const sendingLabel = translate('auth.sending', 'Sending...');
                if (submitBtn) {
                    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2" aria-hidden="true"></i>${sendingLabel}`;
                    submitBtn.disabled = true;
                }

                try {
                    const supabaseClient = window.supabaseClient;
                    if (!supabaseClient || !supabaseClient.auth || typeof supabaseClient.auth.resetPasswordForEmail !== 'function') {
                        throw new Error('Supabase client unavailable');
                    }

                    const redirectTo = buildResetRedirectUrl();
                    const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo });

                    if (error) {
                        throw error;
                    }

                    const successMessage = formatMessage(
                        translate(
                            'auth.forgot_success',
                            '✅ Reset link sent! Please check your email ({email}) for the password reset link.'
                        ),
                        { email }
                    );

                    showMessage(successMessage, 'success');
                    if (emailField) {
                        emailField.value = '';
                    }
                } catch (error) {
                    console.error('Password reset error:', error);

                    const message = (error && error.message ? error.message : '').toLowerCase();

                    if (message.includes('user') && message.includes('not') && message.includes('found')) {
                        showMessage(
                            translate('auth.forgot_error_user_not_found', 'No account found with this email address.'),
                            'error'
                        );
                    } else if (message.includes('rate') && message.includes('limit')) {
                        showMessage(
                            translate(
                                'auth.forgot_error_rate_limit',
                                'Too many reset requests. Please wait a few minutes before trying again.'
                            ),
                            'error'
                        );
                    } else {
                        const fallback = translate('auth.forgot_error_generic', 'Error: {message}');
                        showMessage(
                            formatMessage(fallback, { message: error?.message || 'Unknown error' }),
                            'error'
                        );
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.innerHTML = originalHTML;
                        submitBtn.disabled = false;
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('🔑 Forgot password page loaded');
        });
    </script>
    <div data-component="footer"></div>
    <a class="whatsapp-float" href="https://wa.me/447508497586?text=Hi%20Andre%21%20I%20came%20from%20your%20website%20and%20want%20coaching." target="_blank" rel="noopener noreferrer" aria-label="Contact us on WhatsApp" onclick="return (window.gtag_report_conversion ? gtag_report_conversion(this.href) : true)">WhatsApp</a>
</body>
</html>
