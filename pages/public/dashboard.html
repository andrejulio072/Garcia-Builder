<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title data-i18n="dashboard.title">Client Dashboard  Garcia Builder</title>
    <meta name="description" content="Track your Garcia Builder progress, routines, and milestones in a cinematic coaching dashboard." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/global.css?v=20251028">
    <link rel="stylesheet" href="../../css/layout-fixes.css?v=20251028">
    <link rel="stylesheet" href="../../css/components/navbar-component.css?v=20251028">
    <link rel="stylesheet" href="../../css/components/enhanced-navbar.css?v=20251028">
    <link rel="stylesheet" href="../../css/components/newsletter.css?v=20251028">
    <link rel="stylesheet" href="../../css/pages/dashboard.css?v=20251028">
    <link rel="preload" as="script" href="../../js/utils/component-loader-v3-simplified.js?v=20251027" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="../../components/navbar.html" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="../../components/footer.html" crossorigin="anonymous">
</head>
<body class="dashboard-page">
    <div data-component="navbar" data-variant="dashboard" data-theme="dark"></div>

    <main class="dashboard-main">
        <section class="dashboard-hero">
            <div class="container">
                <div class="dashboard-hero-card js-reveal">
                    <div class="dashboard-user">
                        <img id="user-avatar" src="https://via.placeholder.com/86/111/fff?text=U" alt="User avatar" class="dashboard-avatar" loading="lazy" decoding="async">
                        <div class="dashboard-heading">
                            <h1><span data-i18n="dashboard.welcome_back">Welcome back</span>, <span id="user-name">User</span>!</h1>
                            <p data-i18n="dashboard.subtitle">Your personalised transformation hub keeps everything in one place.</p>
                            <div class="dashboard-meta">
                                <span><i class="fas fa-clock" aria-hidden="true"></i><span data-i18n="dashboard.last_login">Last login</span>: <span id="last-login">Today</span></span>
                                <span><i class="fas fa-award" aria-hidden="true"></i><span data-i18n="dashboard.member_since">Member since</span>: <span id="member-since">2024</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-quick-actions">
                        <a href="my-profile.html" class="btn-quick" data-i18n="dashboard.edit_profile_cta"><i class="fas fa-user-gear"></i>Edit Profile</a>
                        <button type="button" class="btn-quick" id="log-weight-btn"><i class="fas fa-scale-unbalanced"></i><span data-i18n="dashboard.log_weight">Log Weight</span></button>
                        <a href="contact.html" class="btn-quick" data-i18n="dashboard.get_support"><i class="fas fa-comments"></i>Get Support</a>
                        <button type="button" class="btn-quick btn-danger" id="logout-btn"><i class="fas fa-arrow-right-from-bracket"></i><span data-i18n="dashboard.logout">Logout</span></button>
                    </div>
                </div>
            </div>
        </section>

        <section class="dashboard-section">
            <div class="container">
                <div class="dashboard-section-header">
                    <h2 data-i18n="dashboard.metrics_heading">Performance Snapshot</h2>
                    <p data-i18n="dashboard.metrics_subtitle">Auto-generated insights from your latest check-ins.</p>
                </div>
                <div class="stats-grid">
                    <article class="stats-card js-reveal" data-metric="current-weight">
                        <div class="stats-icon"><i class="fas fa-weight-hanging" aria-hidden="true"></i></div>
                        <div class="stats-number" id="current-weight">--</div>
                        <div class="stats-label" data-i18n="dashboard.current_weight">Current Weight</div>
                        <span class="stats-trend trend-neutral" id="weight-trend" data-i18n="dashboard.not_set">Not set</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="bmi">
                        <div class="stats-icon"><i class="fas fa-chart-line" aria-hidden="true"></i></div>
                        <div class="stats-number" id="bmi">--</div>
                        <div class="stats-label">BMI</div>
                        <span class="stats-trend trend-neutral" id="bmi-category">Calculate</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="body-fat">
                        <div class="stats-icon"><i class="fas fa-percentage" aria-hidden="true"></i></div>
                        <div class="stats-number" id="body-fat">--%</div>
                        <div class="stats-label" data-i18n="dashboard.body_fat">Body Fat</div>
                        <span class="stats-trend trend-neutral" id="body-fat-trend">Auto-calculated</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="calories">
                        <div class="stats-icon"><i class="fas fa-fire-flame-curved" aria-hidden="true"></i></div>
                        <div class="stats-number" id="daily-calories">--</div>
                        <div class="stats-label" data-i18n="dashboard.daily_calories">Daily Calories</div>
                        <span class="stats-trend trend-up" id="calories-trend">Recommended</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="hydration">
                        <div class="stats-icon"><i class="fas fa-droplet" aria-hidden="true"></i></div>
                        <div class="stats-number" id="daily-water">--</div>
                        <div class="stats-label" data-i18n="dashboard.daily_water">Daily Water</div>
                        <span class="stats-trend trend-up" id="water-trend">Target</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="progress">
                        <div class="stats-icon"><i class="fas fa-bullseye" aria-hidden="true"></i></div>
                        <div class="stats-number" id="progress-to-goal">--</div>
                        <div class="stats-label" data-i18n="dashboard.progress_goal">Progress to Goal</div>
                        <span class="stats-trend trend-neutral" id="progress-trend">Set target</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="workouts">
                        <div class="stats-icon"><i class="fas fa-dumbbell" aria-hidden="true"></i></div>
                        <div class="stats-number" id="workouts-completed">0</div>
                        <div class="stats-label" data-i18n="dashboard.workouts_completed">Workouts Completed</div>
                        <span class="stats-trend trend-neutral" id="workouts-trend">Getting started</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="streak">
                        <div class="stats-icon"><i class="fas fa-fire" aria-hidden="true"></i></div>
                        <div class="stats-number" id="current-streak">0</div>
                        <div class="stats-label" data-i18n="dashboard.day_streak">Day Streak</div>
                        <span class="stats-trend trend-neutral" id="streak-trend">Keep going!</span>
                    </article>
                </div>
            </div>
        </section>

        <section class="dashboard-section">
            <div class="container">
                <div class="dashboard-grid">
                    <section class="dashboard-card activity-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-clock" aria-hidden="true"></i><span data-i18n="dashboard.recent_activity">Recent Activity</span></h3>
                        <div id="recent-activity" class="activity-feed">
                            <div class="empty-state">
                                <i class="fas fa-history" aria-hidden="true"></i>
                                <p data-i18n="dashboard.no_activity">No recent activity yet. Complete your first check-in to unlock insights.</p>
                                <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                                    <span data-i18n="dashboard.complete_profile">Complete your profile</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-card goals-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-target" aria-hidden="true"></i><span data-i18n="dashboard.your_goals">Your Goals</span></h3>
                        <div id="user-goals" class="goal-list">
                            <div class="empty-state">
                                <i class="fas fa-bullseye" aria-hidden="true"></i>
                                <p data-i18n="dashboard.no_goals">Set personalised goals to track your evolution.</p>
                                <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                                    <span data-i18n="dashboard.set_goals">Define goals</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-card insights-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-calendar-check" aria-hidden="true"></i><span data-i18n="dashboard.next_sessions">Next Sessions</span></h3>
                        <div class="resources-list">
                            <div class="resource-item">
                                <div>
                                    <a href="#" data-i18n="dashboard.session_checkin">Weekly check-in with coach</a>
                                    <div class="resource-meta">Tuesday  09:00 (Online)</div>
                                </div>
                                <span class="stats-trend trend-up">Upcoming</span>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="#" data-i18n="dashboard.session_training">Strength block  Phase 2</a>
                                    <div class="resource-meta">Thursday  Gym flow</div>
                                </div>
                                <span class="stats-trend trend-neutral">Scheduled</span>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="#" data-i18n="dashboard.session_recovery">Recovery & mobility</a>
                                    <div class="resource-meta">Saturday  20 min follow-along</div>
                                </div>
                                <span class="stats-trend trend-neutral">Self-guided</span>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-card resources-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-compass" aria-hidden="true"></i><span data-i18n="dashboard.resources">Resources</span></h3>
                        <div class="resources-list">
                            <div class="resource-item">
                                <div>
                                    <a href="../../assets/transformations.txt" target="_blank" rel="noopener" data-i18n="dashboard.resource_transformations">Transformation spotlight</a>
                                    <div class="resource-meta" data-i18n="dashboard.resource_transformations_meta">See how athletes progressed in 12 weeks.</div>
                                </div>
                                <i class="fas fa-arrow-up-right-from-square" aria-hidden="true"></i>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="../../docs/guides/macros-guide.pdf" target="_blank" rel="noopener" data-i18n="dashboard.resource_macros">Macro calculator cheat-sheet</a>
                                    <div class="resource-meta" data-i18n="dashboard.resource_macros_meta">Adjust nutrition targets with evidence-based ratios.</div>
                                </div>
                                <i class="fas fa-arrow-up-right-from-square" aria-hidden="true"></i>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="../../docs/guides/mindset-playbook.pdf" target="_blank" rel="noopener" data-i18n="dashboard.resource_mindset">Mindset playbook</a>
                                    <div class="resource-meta" data-i18n="dashboard.resource_mindset_meta">Prime your focus for challenging training weeks.</div>
                                </div>
                                <i class="fas fa-arrow-up-right-from-square" aria-hidden="true"></i>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="dashboard-highlights js-reveal">
                    <div class="highlight-card">
                        <span class="stats-label" data-i18n="dashboard.highlight_streak">Consistency</span>
                        <strong id="highlight-streak">0 days</strong>
                        <p data-i18n="dashboard.highlight_streak_meta">Log three consecutive updates to unlock the elite badge.</p>
                    </div>
                    <div class="highlight-card">
                        <span class="stats-label" data-i18n="dashboard.highlight_nutrition">Nutrition</span>
                        <strong id="highlight-nutrition">-- kcal</strong>
                        <p data-i18n="dashboard.highlight_nutrition_meta">Daily targets adjust automatically from your latest intake.</p>
                    </div>
                    <div class="highlight-card">
                        <span class="stats-label" data-i18n="dashboard.highlight_training">Training</span>
                        <strong id="highlight-training">0 sessions</strong>
                        <p data-i18n="dashboard.highlight_training_meta">Schedule workouts inside the app to keep streaks alive.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="dashboard-section">
            <div class="container">
                <article class="dashboard-card js-reveal">
                    <h3 class="card-title"><i class="fas fa-chart-bar" aria-hidden="true"></i><span data-i18n="dashboard.progress_summary">Progress Summary</span></h3>
                    <div class="progress-summary-grid">
                        <div>
                            <div class="stats-number" id="total-sessions">0</div>
                            <div class="stats-label" data-i18n="dashboard.total_sessions">Total Sessions</div>
                        </div>
                        <div>
                            <div class="stats-number" id="target-weight">--</div>
                            <div class="stats-label" data-i18n="dashboard.target_weight">Target Weight</div>
                        </div>
                        <div>
                            <div class="stats-number" id="achievements-count">0</div>
                            <div class="stats-label" data-i18n="dashboard.achievements">Achievements</div>
                        </div>
                        <div>
                            <div class="stats-number" id="days-active">0</div>
                            <div class="stats-label" data-i18n="dashboard.days_active">Days Active</div>
                        </div>
                    </div>
                </article>
            </div>
        </section>
    </main>

    <div data-component="footer" data-theme="dark"></div>
    <a class="whatsapp-float" href="https://wa.me/447508497586?text=Hi%20Andre!%20I%20came%20from%20your%20dashboard%20and%20want%20coaching." target="_blank" rel="noopener" aria-label="Contact via WhatsApp">
        <i class="fab fa-whatsapp" aria-hidden="true"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/core/supabase.js"></script>
    <script src="../../js/utils/component-loader-v3-simplified.js?v=20251027"></script>
    <script src="../../js/email-verification-guard.js"></script>
    <script src="../../js/core/auth.js"></script>
    <script src="../../js/components/navigation-manager.js"></script>
    <script src="../../js/admin/profile-manager.js"></script>
    <script defer src="../../js/body-metrics.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupRevealAnimations();
            initializeDashboard();

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            const logWeightBtn = document.getElementById('log-weight-btn');
            if (logWeightBtn) {
                logWeightBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.BodyMetrics && typeof window.BodyMetrics.showMetricsModal === 'function') {
                        window.BodyMetrics.showMetricsModal();
                    }
                });
            }

            window.addEventListener('gb:bodyMetricsSaved', (e) => {
                try {
                    const data = e.detail || {};
                    if (typeof data.weight === 'number') {
                        updateStatCard('current-weight', `${data.weight}kg`, 'Recorded');
                        const dailyWater = Math.round(data.weight * 35);
                        const liters = (dailyWater / 1000).toFixed(1);
                        updateStatCard('hydration', `${liters}L`, 'Daily target');
                        document.getElementById('highlight-nutrition').textContent = `${Math.max(1800, Math.round(data.weight * 30))} kcal`;
                    }
                    if (typeof data.weight === 'number' && typeof data.height === 'number') {
                        const bmi = data.weight / Math.pow(data.height / 100, 2);
                        updateStatCard('bmi', Math.round(bmi * 10) / 10, getBMICategory(bmi));
                    }
                    if (typeof data.body_fat === 'number') {
                        updateStatCard('body-fat', `${data.body_fat}%`, 'Recorded');
                    }
                    const profileData = window.GarciaProfileManager?.getProfileData?.();
                    const targetWeight = parseFloat(profileData?.body_metrics?.target_weight) || 0;
                    if (typeof data.weight === 'number' && targetWeight > 0) {
                        const diff = Math.abs(data.weight - targetWeight);
                        const direction = data.weight > targetWeight ? 'lose' : 'gain';
                        updateStatCard('progress', `${Math.round(diff * 10) / 10}kg`, `to ${direction}`);
                    }
                    updateDashboardStats();
                } catch (err) {
                    console.warn('Failed to refresh dashboard after metrics save:', err);
                }
            });
        });

        async function initializeDashboard() {
            try {
                if (window.GarciaProfileManager) {
                    await window.GarciaProfileManager.init();
                    updateDashboardContent();
                }
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        }

        function setupRevealAnimations() {
            try {
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    document.querySelectorAll('.js-reveal').forEach(el => el.classList.add('is-visible'));
                    return;
                }

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.15,
                    rootMargin: '0px 0px -60px 0px'
                });

                document.querySelectorAll('.js-reveal').forEach(el => observer.observe(el));
            } catch (error) {
                console.error('Reveal animations failed', error);
            }
        }

        function updateDashboardContent() {
            try {
                const profileData = window.GarciaProfileManager?.getProfileData?.();
                if (!profileData) {
                    return;
                }

                document.getElementById('user-name').textContent = profileData.full_name || 'Athlete';
                document.getElementById('last-login').textContent =
                    new Date(profileData.last_login || Date.now()).toLocaleDateString();
                document.getElementById('member-since').textContent =
                    (profileData.created_at || '').split('T')[0] || '2024';

                if (profileData.avatar_url) {
                    const avatar = document.getElementById('user-avatar');
                    avatar.src = profileData.avatar_url;
                    avatar.alt = profileData.full_name || 'User avatar';
                }

                populateGoals(profileData.goals);
                populateActivity(profileData.activity);
                updateDashboardStats(profileData);
            } catch (error) {
                console.error('Failed to update dashboard content:', error);
            }
        }

        function populateGoals(goals = []) {
            const goalsContainer = document.getElementById('user-goals');
            if (!goalsContainer) return;

            if (!Array.isArray(goals) || goals.length === 0) {
                goalsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bullseye" aria-hidden="true"></i>
                        <p data-i18n="dashboard.no_goals">Set personalised goals to track your evolution.</p>
                        <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                            <span data-i18n="dashboard.set_goals">Define goals</span>
                        </button>
                    </div>`;
                return;
            }

            goalsContainer.innerHTML = goals.map(goal => `
                <div class="goal-item">
                    <div>
                        <strong>${goal.title || 'Goal'}</strong>
                        <p>${goal.description || ''}</p>
                    </div>
                    <span class="stats-trend ${goal.status === 'on-track' ? 'trend-up' : 'trend-neutral'}">
                        ${goal.status === 'completed' ? 'Completed' : goal.status || 'Active'}
                    </span>
                </div>
            `).join('');
        }

        function populateActivity(activity = []) {
            const activityFeed = document.getElementById('recent-activity');
            if (!activityFeed) return;

            if (!Array.isArray(activity) || activity.length === 0) {
                activityFeed.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history" aria-hidden="true"></i>
                        <p data-i18n="dashboard.no_activity">No recent activity yet. Complete your first check-in to unlock insights.</p>
                        <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                            <span data-i18n="dashboard.complete_profile">Complete your profile</span>
                        </button>
                    </div>`;
                return;
            }

            activityFeed.innerHTML = activity.slice(0, 5).map(item => `
                <div class="activity-item">
                    <div>
                        <strong>${item.title || 'Update'}</strong>
                        <p>${item.description || ''}</p>
                    </div>
                    <span class="resource-meta">${new Date(item.date).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        function updateDashboardStats(profileData = {}) {
            const metrics = profileData.body_metrics || {};
            if (metrics.current_weight) {
                updateStatCard('current-weight', `${metrics.current_weight}kg`, 'Updated');
            }
            if (metrics.target_weight && metrics.current_weight) {
                const diff = Math.abs(metrics.current_weight - metrics.target_weight);
                const direction = metrics.current_weight > metrics.target_weight ? 'lose' : 'gain';
                updateStatCard('progress', `${Math.round(diff * 10) / 10}kg`, `to ${direction}`);
            }
            if (metrics.daily_calories) {
                updateStatCard('calories', metrics.daily_calories, 'Recommended');
            }
            if (metrics.daily_water) {
                const liters = (metrics.daily_water / 1000).toFixed(1);
                updateStatCard('hydration', `${liters}L`, 'Target');
            }
            if (metrics.bmi) {
                updateStatCard('bmi', metrics.bmi, getBMICategory(metrics.bmi));
            }
            if (metrics.body_fat) {
                updateStatCard('body-fat', `${metrics.body_fat}%`, 'Measured');
            }

            document.getElementById('highlight-streak').textContent = `${profileData.current_streak || 0} days`;
            document.getElementById('highlight-training').textContent = `${profileData.workouts_completed || 0} sessions`;
            document.getElementById('total-sessions').textContent = profileData.workouts_completed || 0;
            document.getElementById('achievements-count').textContent = Array.isArray(profileData.achievements)
                ? profileData.achievements.length
                : 0;
            document.getElementById('days-active').textContent = profileData.days_active || 0;
            document.getElementById('target-weight').textContent = metrics.target_weight
                ? `${metrics.target_weight}kg`
                : '--';
        }

        function updateStatCard(metric, value, trendText) {
            const card = document.querySelector(`.stats-card[data-metric="${metric}"]`);
            if (!card) return;

            const numberEl = card.querySelector('.stats-number');
            if (numberEl) numberEl.textContent = value;

            const trendEl = card.querySelector('.stats-trend');
            if (trendEl) trendEl.textContent = trendText || '';
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return 'Underweight';
            if (bmi < 25) return 'Normal';
            if (bmi < 30) return 'Overweight';
            return 'Obese';
        }

        async function handleLogout() {
            try {
                if (window.GarciaAuth) {
                    await window.GarciaAuth.signOut();
                }
                window.location.href = '../auth/login.html';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }
    </script>
</body>
</html>
