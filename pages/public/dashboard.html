<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title data-i18n="dashboard.title">Client Dashboard · Garcia Builder</title>
    <meta name="description" content="Track your Garcia Builder progress, routines, and milestones in a cinematic coaching dashboard." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/global.css?v=20251028">
    <link rel="stylesheet" href="../../css/layout-fixes.css?v=20251028">
    <link rel="stylesheet" href="../../css/components/navbar-component.css?v=20251028">
    <link rel="stylesheet" href="../../css/components/enhanced-navbar.css?v=20251028">
    <link rel="stylesheet" href="../../css/components/newsletter.css?v=20251028">
    <link rel="stylesheet" href="../../css/pages/dashboard.css?v=20251028">
    <link rel="preload" as="script" href="../../js/utils/component-loader-v3-simplified.js?v=20251029" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="../../components/navbar.html" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="../../components/footer.html" crossorigin="anonymous">
</head>
<body class="dashboard-page">
    <div data-component="navbar" data-variant="dashboard" data-theme="dark"></div>

    <main class="dashboard-main">
        <section class="dashboard-hero">
            <div class="container">
                <div class="dashboard-hero-card js-reveal">
                    <div class="dashboard-user">
                        <img id="user-avatar" src="https://via.placeholder.com/86/111/fff?text=U" alt="User avatar" class="dashboard-avatar" loading="lazy" decoding="async">
                        <div class="dashboard-heading">
                            <h1><span data-i18n="dashboard.welcome_back">Welcome back</span>, <span id="user-name">User</span>!</h1>
                            <p data-i18n="dashboard.subtitle">Your personalized transformation hub keeps everything in one place.</p>
                            <div class="dashboard-meta">
                                <span><i class="fas fa-clock" aria-hidden="true"></i><span data-i18n="dashboard.last_login">Last login</span>: <span id="last-login">Today</span></span>
                                <span><i class="fas fa-award" aria-hidden="true"></i><span data-i18n="dashboard.member_since">Member since</span>: <span id="member-since">2024</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-quick-actions">
                        <a href="my-profile.html" class="btn-quick"><i class="fas fa-user-gear"></i><span data-i18n="dashboard.edit_profile_cta">Edit Profile</span></a>
                        <button type="button" class="btn-quick" id="log-weight-btn"><i class="fas fa-scale-unbalanced"></i><span data-i18n="dashboard.log_weight">Log Weight</span></button>
                        <a href="../../contact.html" class="btn-quick" data-gb-nav="contact.html"><i class="fas fa-comments"></i><span data-i18n="dashboard.get_support">Get Support</span></a>
                        <button type="button" class="btn-quick btn-danger" id="logout-btn"><i class="fas fa-arrow-right-from-bracket"></i><span data-i18n="dashboard.logout">Logout</span></button>
                    </div>
                </div>
            </div>
        </section>

        <section class="dashboard-section">
            <div class="container">
                <div class="dashboard-section-header">
                    <h2 data-i18n="dashboard.metrics_heading">Performance Snapshot</h2>
                    <p data-i18n="dashboard.metrics_subtitle">Auto-generated insights from your latest check-ins.</p>
                </div>
                <div class="stats-grid">
                    <article class="stats-card js-reveal" data-metric="current-weight">
                        <div class="stats-icon"><i class="fas fa-weight-hanging" aria-hidden="true"></i></div>
                        <div class="stats-number" id="current-weight">--</div>
                        <div class="stats-label" data-i18n="dashboard.current_weight">Current Weight</div>
                        <span class="stats-trend trend-neutral" id="weight-trend" data-i18n="dashboard.not_set">Not set</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="bmi">
                        <div class="stats-icon"><i class="fas fa-chart-line" aria-hidden="true"></i></div>
                        <div class="stats-number" id="bmi">--</div>
                        <div class="stats-label" data-i18n="dashboard.bmi_label">BMI</div>
                        <span class="stats-trend trend-neutral" id="bmi-category" data-i18n="dashboard.bmi_calculate">Calculate</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="body-fat">
                        <div class="stats-icon"><i class="fas fa-percentage" aria-hidden="true"></i></div>
                        <div class="stats-number" id="body-fat">--%</div>
                        <div class="stats-label" data-i18n="dashboard.body_fat">Body Fat</div>
                        <span class="stats-trend trend-neutral" id="body-fat-trend" data-i18n="dashboard.auto_calculated">Auto-calculated</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="calories">
                        <div class="stats-icon"><i class="fas fa-fire-flame-curved" aria-hidden="true"></i></div>
                        <div class="stats-number" id="daily-calories">--</div>
                        <div class="stats-label" data-i18n="dashboard.daily_calories">Daily Calories</div>
                        <span class="stats-trend trend-up" id="calories-trend" data-i18n="dashboard.recommended">Recommended</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="hydration">
                        <div class="stats-icon"><i class="fas fa-droplet" aria-hidden="true"></i></div>
                        <div class="stats-number" id="daily-water">--</div>
                        <div class="stats-label" data-i18n="dashboard.daily_water">Daily Water</div>
                        <span class="stats-trend trend-up" id="water-trend" data-i18n="dashboard.target">Target</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="progress">
                        <div class="stats-icon"><i class="fas fa-bullseye" aria-hidden="true"></i></div>
                        <div class="stats-number" id="progress-to-goal">--</div>
                        <div class="stats-label" data-i18n="dashboard.progress_goal">Progress to Goal</div>
                        <span class="stats-trend trend-neutral" id="progress-trend" data-i18n="dashboard.set_target">Set target</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="workouts">
                        <div class="stats-icon"><i class="fas fa-dumbbell" aria-hidden="true"></i></div>
                        <div class="stats-number" id="workouts-completed">0</div>
                        <div class="stats-label" data-i18n="dashboard.workouts_completed">Workouts Completed</div>
                        <span class="stats-trend trend-neutral" id="workouts-trend" data-i18n="dashboard.getting_started">Getting started</span>
                    </article>

                    <article class="stats-card js-reveal" data-metric="streak">
                        <div class="stats-icon"><i class="fas fa-fire" aria-hidden="true"></i></div>
                        <div class="stats-number" id="current-streak">0</div>
                        <div class="stats-label" data-i18n="dashboard.day_streak">Day Streak</div>
                        <span class="stats-trend trend-neutral" id="streak-trend" data-i18n="dashboard.keep_going">Keep going!</span>
                    </article>
                </div>
            </div>
        </section>

        <section class="dashboard-section">
            <div class="container">
                <div class="dashboard-grid">
                    <section class="dashboard-card activity-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-clock" aria-hidden="true"></i><span data-i18n="dashboard.recent_activity">Recent Activity</span></h3>
                        <div id="recent-activity" class="activity-feed">
                            <div class="empty-state">
                                <i class="fas fa-history" aria-hidden="true"></i>
                                <p data-i18n="dashboard.no_activity">No recent activity yet. Complete your first check-in to unlock insights.</p>
                                <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                                    <span data-i18n="dashboard.complete_profile">Complete your profile</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-card goals-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-target" aria-hidden="true"></i><span data-i18n="dashboard.your_goals">Your Goals</span></h3>
                        <div id="user-goals" class="goal-list">
                            <div class="empty-state">
                                <i class="fas fa-bullseye" aria-hidden="true"></i>
                                <p data-i18n="dashboard.no_goals">Set personalized goals to track your evolution.</p>
                                <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                                    <span data-i18n="dashboard.set_goals">Define goals</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-card insights-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-calendar-check" aria-hidden="true"></i><span data-i18n="dashboard.next_sessions">Next Sessions</span></h3>
                        <div class="resources-list">
                            <div class="resource-item">
                                <div>
                                    <a href="#" data-i18n="dashboard.session_checkin">Weekly check-in with coach</a>
                                    <div class="resource-meta" data-i18n="dashboard.session_checkin_meta">Tuesday · 09:00 (Online)</div>
                                </div>
                                <span class="stats-trend trend-up" data-i18n="dashboard.session_status_upcoming">Upcoming</span>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="#" data-i18n="dashboard.session_training">Strength block · Phase 2</a>
                                    <div class="resource-meta" data-i18n="dashboard.session_training_meta">Thursday · Gym flow</div>
                                </div>
                                <span class="stats-trend trend-neutral" data-i18n="dashboard.session_status_scheduled">Scheduled</span>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="#" data-i18n="dashboard.session_recovery">Recovery &amp; mobility</a>
                                    <div class="resource-meta" data-i18n="dashboard.session_recovery_meta">Saturday · 20 min follow-along</div>
                                </div>
                                <span class="stats-trend trend-neutral" data-i18n="dashboard.session_status_selfguided">Self-guided</span>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-card resources-card js-reveal">
                        <h3 class="card-title"><i class="fas fa-compass" aria-hidden="true"></i><span data-i18n="dashboard.resources">Resources</span></h3>
                        <div class="resources-list">
                            <div class="resource-item">
                                <div>
                                    <a href="../../assets/transformations.txt" target="_blank" rel="noopener" data-i18n="dashboard.resource_transformations">Transformation spotlight</a>
                                    <div class="resource-meta" data-i18n="dashboard.resource_transformations_meta">See how athletes progressed in 12 weeks.</div>
                                </div>
                                <i class="fas fa-arrow-up-right-from-square" aria-hidden="true"></i>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="../../docs/guides/macros-guide.pdf" target="_blank" rel="noopener" data-i18n="dashboard.resource_macros">Macro calculator cheat-sheet</a>
                                    <div class="resource-meta" data-i18n="dashboard.resource_macros_meta">Adjust nutrition targets with evidence-based ratios.</div>
                                </div>
                                <i class="fas fa-arrow-up-right-from-square" aria-hidden="true"></i>
                            </div>
                            <div class="resource-item">
                                <div>
                                    <a href="../../docs/guides/mindset-playbook.pdf" target="_blank" rel="noopener" data-i18n="dashboard.resource_mindset">Mindset playbook</a>
                                    <div class="resource-meta" data-i18n="dashboard.resource_mindset_meta">Prime your focus for challenging training weeks.</div>
                                </div>
                                <i class="fas fa-arrow-up-right-from-square" aria-hidden="true"></i>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="dashboard-highlights js-reveal">
                    <div class="highlight-card">
                        <span class="stats-label" data-i18n="dashboard.highlight_streak">Consistency</span>
                        <strong id="highlight-streak">0 days</strong>
                        <p data-i18n="dashboard.highlight_streak_meta">Log three consecutive updates to unlock the elite badge.</p>
                    </div>
                    <div class="highlight-card">
                        <span class="stats-label" data-i18n="dashboard.highlight_nutrition">Nutrition</span>
                        <strong id="highlight-nutrition">-- kcal</strong>
                        <p data-i18n="dashboard.highlight_nutrition_meta">Daily targets adjust automatically from your latest intake.</p>
                    </div>
                    <div class="highlight-card">
                        <span class="stats-label" data-i18n="dashboard.highlight_training">Training</span>
                        <strong id="highlight-training">0 sessions</strong>
                        <p data-i18n="dashboard.highlight_training_meta">Schedule workouts inside the app to keep streaks alive.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="dashboard-section">
            <div class="container">
                <article class="dashboard-card js-reveal">
                    <h3 class="card-title"><i class="fas fa-chart-bar" aria-hidden="true"></i><span data-i18n="dashboard.progress_summary">Progress Summary</span></h3>
                    <div class="progress-summary-grid">
                        <div>
                            <div class="stats-number" id="total-sessions">0</div>
                            <div class="stats-label" data-i18n="dashboard.total_sessions">Total Sessions</div>
                        </div>
                        <div>
                            <div class="stats-number" id="target-weight">--</div>
                            <div class="stats-label" data-i18n="dashboard.target_weight">Target Weight</div>
                        </div>
                        <div>
                            <div class="stats-number" id="achievements-count">0</div>
                            <div class="stats-label" data-i18n="dashboard.achievements">Achievements</div>
                        </div>
                        <div>
                            <div class="stats-number" id="days-active">0</div>
                            <div class="stats-label" data-i18n="dashboard.days_active">Days Active</div>
                        </div>
                    </div>
                </article>
            </div>
        </section>
    </main>

    <div data-component="footer" data-theme="dark"></div>
    <a class="whatsapp-float" href="https://wa.me/447508497586" target="_blank" rel="noopener" aria-label="Contact via WhatsApp">
        <i class="fab fa-whatsapp" aria-hidden="true"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/core/supabase.js"></script>
    <script src="../../js/utils/component-loader-v3-simplified.js?v=20251029"></script>
    <script src="../../js/email-verification-guard.js"></script>
    <script src="../../js/core/auth.js"></script>
    <script src="../../js/auth-guard.js"></script>
    <script src="../../js/components/navigation-manager.js"></script>
    <script src="../../js/admin/profile-manager.js"></script>
    <script defer src="../../js/body-metrics.js"></script>

    <script>
        const translate = (key, fallback) => {
            try {
                const api = window.GBi18n;
                if (api && typeof api.t === 'function') {
                    const value = api.t(key);
                    if (typeof value === 'string' && value.trim()) {
                        return value;
                    }
                }
            } catch (err) {
                console.warn('i18n lookup failed for', key, err);
            }
            return fallback;
        };

        const formatMessage = (template, replacements = {}) => {
            if (typeof template !== 'string') {
                return '';
            }
            return template.replace(/\{(\w+)\}/g, (_, token) => {
                return Object.prototype.hasOwnProperty.call(replacements, token)
                    ? replacements[token]
                    : `{${token}}`;
            });
        };

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof AuthSystem !== 'undefined' && typeof AuthSystem.requireAuth === 'function') {
                const allowed = AuthSystem.requireAuth();
                if (!allowed) {
                    return;
                }
            }

            setupRevealAnimations();
            configureWhatsAppLink();
            setFallbackAvatarLabel();
            initializeDashboard();

            if (window.GarciaNavigationManager && typeof window.GarciaNavigationManager.updateNavigation === 'function') {
                window.GarciaNavigationManager.updateNavigation();
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            const logWeightBtn = document.getElementById('log-weight-btn');
            if (logWeightBtn) {
                logWeightBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.BodyMetrics && typeof window.BodyMetrics.showMetricsModal === 'function') {
                        window.BodyMetrics.showMetricsModal();
                    }
                });
            }

            document.addEventListener('languageChanged', () => {
                configureWhatsAppLink();
                setFallbackAvatarLabel();
                updateDashboardContent();
            });

            window.addEventListener('gb:bodyMetricsSaved', (e) => {
                try {
                    const data = e.detail || {};
                    if (typeof data.weight === 'number') {
                        updateStatCard('current-weight', `${data.weight}kg`, translate('dashboard.recorded', 'Recorded'));
                        const dailyWater = Math.round(data.weight * 35);
                        const liters = (dailyWater / 1000).toFixed(1);
                        updateStatCard('hydration', `${liters}L`, translate('dashboard.daily_target', 'Daily target'));
                        document.getElementById('highlight-nutrition').textContent = `${Math.max(1800, Math.round(data.weight * 30))} kcal`;
                    }
                    if (typeof data.weight === 'number' && typeof data.height === 'number') {
                        const bmi = data.weight / Math.pow(data.height / 100, 2);
                        updateStatCard('bmi', Math.round(bmi * 10) / 10, getBMICategory(bmi));
                    }
                    if (typeof data.body_fat === 'number') {
                        updateStatCard('body-fat', `${data.body_fat}%`, translate('dashboard.recorded', 'Recorded'));
                    }
                    const profileData = window.GarciaProfileManager?.getProfileData?.();
                    const targetWeight = parseFloat(profileData?.body_metrics?.target_weight) || 0;
                    if (typeof data.weight === 'number' && targetWeight > 0) {
                        const diff = Math.abs(data.weight - targetWeight);
                        const direction = data.weight > targetWeight ? 'lose' : 'gain';
                        const directionLabel = translate(
                            direction === 'lose' ? 'dashboard.direction_lose' : 'dashboard.direction_gain',
                            direction
                        );
                        const overlay = formatMessage(
                            translate('dashboard.progress_to_direction', 'to {direction}'),
                            { direction: directionLabel }
                        );
                        updateStatCard('progress', `${Math.round(diff * 10) / 10}kg`, overlay);
                    }
                    updateDashboardStats(profileData || {});
                } catch (err) {
                    console.warn('Failed to refresh dashboard after metrics save:', err);
                }
            });
        });

        function configureWhatsAppLink() {
            const whatsappLink = document.querySelector('.whatsapp-float');
            if (!whatsappLink) return;

            whatsappLink.setAttribute(
                'aria-label',
                translate('dashboard.contact_whatsapp_label', 'Contact via WhatsApp')
            );

            const baseUrl = 'https://wa.me/447508497586';
            const message = translate(
                'dashboard.contact_whatsapp_message',
                'Hi Andre! I came from your dashboard and want coaching.'
            );
            whatsappLink.href = `${baseUrl}?text=${encodeURIComponent(message)}`;
        }

        function setFallbackAvatarLabel() {
            const avatar = document.getElementById('user-avatar');
            if (!avatar) return;
            const currentAlt = (avatar.getAttribute('alt') || '').trim();
            if (!currentAlt || currentAlt === 'User avatar') {
                avatar.setAttribute('alt', translate('dashboard.user_avatar_alt', 'User avatar'));
            }
        }

        /**
         * Generates a data URI avatar with user initials
         * @param {string} name - User's full name
         * @returns {string} Data URI for the generated avatar
         */
        function generateAvatarWithInitials(name) {
            // Get initials (max 2 letters)
            const initials = name
                .split(' ')
                .filter(word => word.length > 0)
                .map(word => word[0].toUpperCase())
                .slice(0, 2)
                .join('');

            // Create canvas
            const canvas = document.createElement('canvas');
            const size = 86;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // Background gradient (Garcia Builder brand colors)
            const gradient = ctx.createLinearGradient(0, 0, size, size);
            gradient.addColorStop(0, '#FF6B35');  // Orange
            gradient.addColorStop(1, '#004E89');  // Blue
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size, size);

            // Text
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 36px system-ui, -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials || 'U', size / 2, size / 2);

            return canvas.toDataURL('image/png');
        }

        async function initializeDashboard() {
            try {
                console.log('🚀 Initializing dashboard...');

                // Verify authentication first
                if (window.supabaseClient) {
                    const { data: session } = await window.supabaseClient.auth.getSession();
                    console.log('🔐 Session status:', session ? '✅ Active' : '❌ No session');
                    if (session?.session) {
                        console.log('👤 Session user:', session.session.user.email);
                        console.log('📸 Session user metadata:', session.session.user.user_metadata);
                    }
                } else {
                    console.error('❌ supabaseClient not available!');
                }

                if (window.GarciaProfileManager) {
                    await window.GarciaProfileManager.init();
                    updateDashboardContent();
                } else {
                    console.error('❌ GarciaProfileManager not available!');
                }
            } catch (error) {
                console.error('❌ Error initializing dashboard:', error);
            }
        }

        function setupRevealAnimations() {
            try {
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    document.querySelectorAll('.js-reveal').forEach(el => el.classList.add('is-visible'));
                    return;
                }

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.15,
                    rootMargin: '0px 0px -60px 0px'
                });

                document.querySelectorAll('.js-reveal').forEach(el => observer.observe(el));
            } catch (error) {
                console.error('Reveal animations failed', error);
            }
        }

        async function updateDashboardContent() {
            try {
                console.log('📊 Updating dashboard content...');

                // Get profile data
                const profileData = window.GarciaProfileManager?.getProfileData?.();
                console.log('Profile data:', profileData);

                // Get current user from multiple sources for robustness
                let currentUser = null;
                let oauthPicture = null;

                // Try 1: Supabase session (most reliable for OAuth data)
                if (window.supabaseClient) {
                    try {
                        console.log('🔍 Fetching Supabase session...');
                        const { data: sessionData } = await window.supabaseClient.auth.getSession();
                        if (sessionData?.session?.user) {
                            currentUser = sessionData.session.user;
                            oauthPicture = currentUser.user_metadata?.picture ||
                                          currentUser.user_metadata?.avatar_url;
                            console.log('✅ Session user:', currentUser.email);
                            console.log('📸 OAuth picture from session:', oauthPicture);
                        }
                    } catch (err) {
                        console.warn('⚠️ Session fetch failed, trying getUser...', err);
                    }

                    // Try 2: getUser as fallback
                    if (!currentUser) {
                        try {
                            const { data, error } = await window.supabaseClient.auth.getUser();
                            if (error) {
                                console.warn('❌ Supabase getUser error:', error);
                            } else {
                                currentUser = data?.user;
                                oauthPicture = currentUser?.user_metadata?.picture ||
                                              currentUser?.user_metadata?.avatar_url;
                                console.log('✅ Current user from getUser:', currentUser?.email);
                                console.log('� OAuth picture from getUser:', oauthPicture);
                            }
                        } catch (err) {
                            console.error('❌ Failed to fetch Supabase user:', err);
                        }
                    }
                } else {
                    console.warn('⚠️ window.supabaseClient not available!');
                }

                // Try 3: localStorage backup
                if (!currentUser) {
                    try {
                        const storedUser = localStorage.getItem('gb_current_user');
                        if (storedUser) {
                            const parsed = JSON.parse(storedUser);
                            currentUser = parsed;
                            oauthPicture = parsed.user_metadata?.picture || parsed.avatar_url;
                            console.log('💾 Using stored user from localStorage:', currentUser.email);
                            console.log('📸 Picture from localStorage:', oauthPicture);
                        }
                    } catch (err) {
                        console.warn('⚠️ Failed to read localStorage user:', err);
                    }
                }

                if (!profileData && !currentUser) {
                    console.warn('⚠️ No profile data or user available');
                    return;
                }

                // Update name
                const fullName = profileData.basic?.full_name ||
                                profileData.full_name ||
                                currentUser?.user_metadata?.full_name ||
                                currentUser?.email ||
                                translate('dashboard.default_name', 'Athlete');

                document.getElementById('user-name').textContent = fullName;

                // Update login info
                document.getElementById('last-login').textContent =
                    new Date(profileData.last_login || Date.now()).toLocaleDateString();
                document.getElementById('member-since').textContent =
                    (profileData.basic?.joined_date || profileData.created_at || '').split('T')[0] || '2024';

                // Update avatar with priority: OAuth picture > saved avatar_url > initials
                const avatar = document.getElementById('user-avatar');
                if (avatar) {
                    let avatarSrc = null;

                    // Priority 1: OAuth picture (already extracted from multiple sources above)
                    if (oauthPicture) {
                        avatarSrc = oauthPicture;
                        console.log('✅ Using OAuth avatar:', avatarSrc);
                    }
                    // Priority 2: Saved avatar_url in profile
                    else if (profileData?.basic?.avatar_url || profileData?.avatar_url) {
                        avatarSrc = profileData.basic?.avatar_url || profileData.avatar_url;
                        console.log('✅ Using saved avatar:', avatarSrc);
                    }
                    // Priority 3: Generate with initials
                    else {
                        avatarSrc = generateAvatarWithInitials(fullName);
                        console.log('✅ Generated initials avatar for:', fullName);
                    }

                    avatar.src = avatarSrc;
                    avatar.alt = fullName;
                    console.log('🖼️ Final avatar set:', avatarSrc?.substring?.(0, 60) + '...');
                }

                populateGoals(profileData?.basic?.goals || profileData?.goals);
                populateActivity(profileData?.activity);
                updateDashboardStats(profileData);
                setFallbackAvatarLabel();

                console.log('✅ Dashboard content updated');
            } catch (error) {
                console.error('❌ Failed to update dashboard content:', error);
            }
        }

        function populateGoals(goals = []) {
            const goalsContainer = document.getElementById('user-goals');
            if (!goalsContainer) return;

            if (!Array.isArray(goals) || goals.length === 0) {
                goalsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bullseye" aria-hidden="true"></i>
                        <p data-i18n="dashboard.no_goals">Set personalized goals to track your evolution.</p>
                        <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                            <span data-i18n="dashboard.set_goals">Define goals</span>
                        </button>
                    </div>`;
                return;
            }

            goalsContainer.innerHTML = goals.map(goal => `
                <div class="goal-item">
                    <div>
                        <strong>${goal.title || translate('dashboard.goal_default', 'Goal')}</strong>
                        <p>${goal.description || ''}</p>
                    </div>
                    <span class="stats-trend ${goal.status === 'on-track' ? 'trend-up' : 'trend-neutral'}">
                        ${(() => {
                            const status = (goal.status || '').toLowerCase();
                            if (status === 'completed') {
                                return translate('dashboard.goal_completed', 'Completed');
                            }
                            if (status === 'on-track') {
                                return translate('dashboard.goal_ontrack', 'On track');
                            }
                            if (status === 'paused') {
                                return translate('dashboard.goal_paused', 'Paused');
                            }
                            return translate('dashboard.goal_active', 'Active');
                        })()}
                    </span>
                </div>
            `).join('');
        }

        function populateActivity(activity = []) {
            const activityFeed = document.getElementById('recent-activity');
            if (!activityFeed) return;

            if (!Array.isArray(activity) || activity.length === 0) {
                activityFeed.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history" aria-hidden="true"></i>
                        <p data-i18n="dashboard.no_activity">No recent activity yet. Complete your first check-in to unlock insights.</p>
                        <button class="btn-primary-custom" type="button" onclick="window.location.href='my-profile.html'">
                            <span data-i18n="dashboard.complete_profile">Complete your profile</span>
                        </button>
                    </div>`;
                return;
            }

            activityFeed.innerHTML = activity.slice(0, 5).map(item => `
                <div class="activity-item">
                    <div>
                        <strong>${item.title || translate('dashboard.activity_update', 'Update')}</strong>
                        <p>${item.description || ''}</p>
                    </div>
                    <span class="resource-meta">${new Date(item.date).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        function updateDashboardStats(profileData = {}) {
            const metrics = profileData.body_metrics || {};
            if (metrics.current_weight) {
                updateStatCard('current-weight', `${metrics.current_weight}kg`, translate('dashboard.updated', 'Updated'));
            }
            if (metrics.target_weight && metrics.current_weight) {
                const diff = Math.abs(metrics.current_weight - metrics.target_weight);
                const direction = metrics.current_weight > metrics.target_weight ? 'lose' : 'gain';
                const directionLabel = translate(
                    direction === 'lose' ? 'dashboard.direction_lose' : 'dashboard.direction_gain',
                    direction
                );
                const overlay = formatMessage(
                    translate('dashboard.progress_to_direction', 'to {direction}'),
                    { direction: directionLabel }
                );
                updateStatCard('progress', `${Math.round(diff * 10) / 10}kg`, overlay);
            }
            if (metrics.daily_calories) {
                updateStatCard('calories', metrics.daily_calories, translate('dashboard.recommended', 'Recommended'));
            }
            if (metrics.daily_water) {
                const liters = (metrics.daily_water / 1000).toFixed(1);
                updateStatCard('hydration', `${liters}L`, translate('dashboard.target', 'Target'));
            }
            if (metrics.bmi) {
                updateStatCard('bmi', metrics.bmi, getBMICategory(metrics.bmi));
            }
            if (metrics.body_fat) {
                updateStatCard('body-fat', `${metrics.body_fat}%`, translate('dashboard.measured', 'Measured'));
            }

            updateHighlightSummaries(profileData);
            document.getElementById('achievements-count').textContent = Array.isArray(profileData.achievements)
                ? profileData.achievements.length
                : 0;
            document.getElementById('days-active').textContent = profileData.days_active || 0;
            document.getElementById('target-weight').textContent = metrics.target_weight
                ? `${metrics.target_weight}kg`
                : '--';
        }

        function updateHighlightSummaries(profileData = {}) {
            const streakCount = Number(profileData.current_streak) || 0;
            const workoutsCount = Number(profileData.workouts_completed) || 0;
            const dayLabel = streakCount === 1
                ? translate('dashboard.day_single', 'day')
                : translate('dashboard.day_plural', 'days');
            const sessionLabel = workoutsCount === 1
                ? translate('dashboard.session_single', 'session')
                : translate('dashboard.session_plural', 'sessions');

            document.getElementById('highlight-streak').textContent = `${streakCount} ${dayLabel}`;
            document.getElementById('highlight-training').textContent = `${workoutsCount} ${sessionLabel}`;
            document.getElementById('total-sessions').textContent = workoutsCount;
        }

        function updateStatCard(metric, value, trendText) {
            const card = document.querySelector(`.stats-card[data-metric="${metric}"]`);
            if (!card) return;

            const numberEl = card.querySelector('.stats-number');
            if (numberEl) numberEl.textContent = value;

            const trendEl = card.querySelector('.stats-trend');
            if (trendEl) trendEl.textContent = trendText || '';
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return translate('dashboard.bmi_underweight', 'Underweight');
            if (bmi < 25) return translate('dashboard.bmi_normal', 'Normal');
            if (bmi < 30) return translate('dashboard.bmi_overweight', 'Overweight');
            return translate('dashboard.bmi_obese', 'Obese');
        }

        async function handleLogout() {
            try {
                console.log('🚪 Dashboard logout initiated');

                // Try AuthSystem first (this is now the corrected version)
                if (typeof AuthSystem !== 'undefined' && typeof AuthSystem.logout === 'function') {
                    await AuthSystem.logout();
                    return;
                }

                // Fallback to AuthGuard
                if (window.AuthGuard && typeof window.AuthGuard.handleLogout === 'function') {
                    const fakeEvent = { preventDefault: () => {}, stopPropagation: () => {} };
                    window.AuthGuard.handleLogout(fakeEvent);
                    return;
                }

                // Manual logout as last resort
                console.log('⚠️ Using manual logout fallback');

                // Clear all storage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('sb-') || key.includes('supabase'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                localStorage.removeItem('gb_current_user');
                localStorage.removeItem('gb_remember_me');
                sessionStorage.clear();

                // Try Supabase signOut
                if (window.supabaseClient?.auth) {
                    await window.supabaseClient.auth.signOut();
                } else if (window.GarciaAuth && typeof window.GarciaAuth.signOut === 'function') {
                    await window.GarciaAuth.signOut();
                }

                // Redirect
                const loginUrl = typeof toAbsoluteUrl === 'function'
                    ? toAbsoluteUrl('pages/auth/login.html')
                    : '../auth/login.html';
                window.location.replace(loginUrl + '?t=' + Date.now());
            } catch (error) {
                console.error('❌ Error logging out:', error);
                // Force redirect even on error
                window.location.replace('../auth/login.html');
            }
        }
    </script>
</body>
</html>
