<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SEO & Social: Favicon, Meta Tags, Open Graph, Twitter Card, Structured Data -->
    <link rel="icon" href="Logo Files/For Web/logo-nobackground-500.png" type="image/png">
    <link rel="apple-touch-icon" href="Logo Files/For Web/logo-nobackground-500.png">
    <title>Garcia Builder | Personalized Online Training & Nutrition</title>
    <meta name="description" content="Personalized fitness coaching to transform your body and performance in 8-12 weeks. 1:1 support and real results.">
    <meta property="og:title" content="Garcia Builder - Online Coaching">
    <meta property="og:description" content="Personalized training, custom nutrition, and direct support. Transform your body efficiently.">
    <meta property="og:image" content="https://garciabuilder.fitness/Logo%20Files/For%20Web/logo-nobackground-500.png">
    <meta property="og:url" content="https://garciabuilder.fitness/success.html">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Garcia Builder - Online Coaching">
    <meta name="twitter:description" content="Personalized training, custom nutrition, and direct support. Transform your body efficiently.">
    <meta name="twitter:image" content="https://garciabuilder.fitness/Logo%20Files/For%20Web/logo-nobackground-500.png">
    <!-- Dados estruturados para rich results -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "HealthAndBeautyBusiness",
        "name": "Garcia Builder",
        "url": "https://garciabuilder.fitness/success.html",
        "logo": "https://garciabuilder.fitness/Logo%20Files/For%20Web/logo-nobackground-500.png",
        "sameAs": [
            "https://www.instagram.com/garcia.builder"
        ]
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Success - Garcia Builder</title>
    <!-- Optional: set a Trainerize invite link without code changes -->
    <meta name="trainerize:invite" content="">
    <!-- Optional: Booking URL for onboarding consult -->
    <meta name="booking:url" content="">

    <!-- Google Ads Global Site Tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1762742053"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-1762742053');
      gtag('config', 'AW-17627402053');
    </script>

    <!-- Event snippet for Visualização de página conversion page -->
    <script>
      function gtag_report_conversion(url) {
        var callback = function () {
          if (typeof(url) != 'undefined') {
            window.location = url;
          }
        };
        gtag('event', 'conversion', {
            'send_to': 'AW-17627402053/mdOMCOTV3acbEMWes9VB',
            'value': 1.0,
            'currency': 'GBP',
            'event_callback': callback
        });
        return false;
      }
    </script>

    <!-- Central consent-aware Ads loader -->
    <script defer src="js/ads-loader.js"></script>
    <script defer src="js/ads-config.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/global.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            min-height: 100vh;
        }

        .success-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }

        .success-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 22px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 3rem;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1.5rem;
            animation: checkmark 0.8s ease-in-out;
        }

        @keyframes checkmark {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .success-title {
            background: linear-gradient(135deg, #F6C84E, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container inner">
            <a class="brand" href="index.html">
                <img loading="lazy" decoding="async" src="Logo Files/For Web/logo-nobackground-500.png" alt="Garcia Builder logo"/>
                <span class="title-gradient">Garcia Builder</span>
            </a>
        </div>
    </nav>

    <div class="success-container">
        <div class="container">
            <div class="success-card">
                <div id="loading-state">
                    <i class="fas fa-spinner fa-spin success-icon"></i>
                    <h1 class="success-title">Verificando Pagamento<span class="loading-dots"></span></h1>
                    <p class="lead">Aguarde enquanto confirmamos seu pagamento...</p>
                </div>

                <div id="success-state" style="display: none;">
                    <i class="fas fa-check-circle success-icon"></i>
                    <h1 class="success-title" data-i18n="success.title">Pagamento Confirmado!</h1>
                    <p class="lead mb-4" data-i18n="success.subtitle">Obrigado por escolher o Garcia Builder. Sua jornada de transformação começou!</p>

                    <div class="payment-details mb-4" id="payment-details">
                        <!-- Detalhes do pagamento serão inseridos aqui -->
                    </div>

                    <div class="next-steps">
                        <h4 class="mb-3" data-i18n="success.next_steps.title">Próximos Passos:</h4>
                        <div class="row text-start">
                            <div class="col-12 mb-3">
                                <a id="trainerize-cta" href="#" target="_blank" class="btn btn-warning w-100 fw-bold" style="color:#0b1220">
                                    <i class="fas fa-bolt me-2"></i>
                                    <span data-i18n="success.next_steps.trainerize_invite">Acessar convite do Trainerize</span>
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a id="book-cta" href="#" target="_blank" class="btn btn-outline-light w-100">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    <span data-i18n="success.next_steps.book">Agendar consulta de onboarding</span>
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="first-workout.html" class="btn btn-outline-warning w-100">
                                    <i class="fas fa-dumbbell me-2"></i>
                                    <span data-i18n="success.next_steps.first_workout">Fazer o primeiro treino (Dia 1)</span>
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-envelope text-primary me-3 mt-1"></i>
                                    <div>
                                        <h6 data-i18n="success.next_steps.email.title">Verifique seu Email</h6>
                                        <small class="text-muted" data-i18n="success.next_steps.email.desc">Enviamos instruções detalhadas para começar</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-mobile-alt text-success me-3 mt-1"></i>
                                    <div>
                                        <h6 data-i18n="success.next_steps.app.title">Download do App</h6>
                                        <small class="text-muted" data-i18n="success.next_steps.app.desc">Baixe o Trainerize para acompanhar seus treinos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-whatsapp text-success me-3 mt-1"></i>
                                    <div>
                                        <h6 data-i18n="success.next_steps.whatsapp.title">WhatsApp</h6>
                                        <small class="text-muted" data-i18n="success.next_steps.whatsapp.desc">Você será adicionado ao grupo de suporte</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-calendar-check text-warning me-3 mt-1"></i>
                                    <div>
                                        <h6 data-i18n="success.next_steps.schedule.title">Agendar Chamada</h6>
                                        <small class="text-muted" data-i18n="success.next_steps.schedule.desc">Vamos criar seu plano personalizado</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <a href="dashboard.html" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            <span data-i18n="success.go_to_dashboard">Ir para Dashboard</span>
                        </a>
                        <a href="https://wa.me/447508497586?text=Hi%20Andre%21%20I%20just%20completed%20my%20payment%20and%20I%27m%20ready%20to%20start!"
                           target="_blank" class="btn btn-success btn-lg" onclick="return gtag_report_conversion(this.href)">
                            <i class="fab fa-whatsapp me-2"></i>
                            <span data-i18n="success.contact_coach">Falar com o Coach</span>
                        </a>
                    </div>
                </div>

                <div id="error-state" style="display: none;">
                    <i class="fas fa-exclamation-triangle text-warning success-icon"></i>
                    <h1 class="success-title">Verification Error</h1>
                    <p class="lead mb-4">There was a problem verifying your payment. Please contact us.</p>

                    <div class="mt-4">
                        <a href="pricing.html" class="btn btn-outline-primary me-3">
                            <i class="fas fa-arrow-left me-2"></i>Back to Plans
                        </a>
                        <a href="contact.html" class="btn btn-primary">
                            <i class="fas fa-envelope me-2"></i>Contact Support
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="js/i18n-shim.js"></script>
    <script defer src="assets/i18n.js?v=20250926"></script>

    <script>
        // Verificar status do pagamento
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');

            if (!sessionId) {
                showError('Session ID não encontrado');
                return;
            }

            try {
                // Verificar status do pagamento
                const response = await fetch(`/api/payment-status/${sessionId}`);
                const data = await response.json();

                if (response.ok && data.status === 'paid') {
                    showSuccess(data);
                } else {
                    showError('Pagamento não confirmado');
                }
            } catch (error) {
                console.error('Erro ao verificar pagamento:', error);
                showError('Erro ao verificar pagamento');
            }
        });

        function showSuccess(paymentData) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('success-state').style.display = 'block';

            // Mostrar detalhes do pagamento
            if (paymentData.customer_email) {
                const detailsHtml = `
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Email:</strong> ${paymentData.customer_email}
                        ${paymentData.subscription_id ? `<br><strong>ID da Assinatura:</strong> ${paymentData.subscription_id}` : ''}
                    </div>
                `;
                document.getElementById('payment-details').innerHTML = detailsHtml;
            }

                        // ---- Tracking (GA4 + Meta Pixel) ----
            try {
                window.dataLayer = window.dataLayer || [];
                const planKey = paymentData.plan_key || paymentData.plan || 'unknown_plan';
                const grossValue = paymentData.amount_total ? (paymentData.amount_total/100) : (paymentData.amount/100) || 0;
                const currency = (paymentData.currency || 'GBP').toUpperCase();
                const transactionId = paymentData.session_id || paymentData.subscription_id || paymentData.invoice_id || ('txn_'+Date.now());
                const adsDebug = function(){ if(window.DEBUG_ADS) { console.log('[ADS]', ...arguments); } };
                                const items = [{
                                    item_id: planKey,
                                    item_name: paymentData.plan_name || planKey,
                                    price: grossValue,
                                    quantity: 1
                                }];
                                window.dataLayer.push({
                                    event: 'purchase',
                                    transaction_id: transactionId,
                                    value: grossValue,
                                    currency: currency,
                                    items: items
                                });
                                adsDebug('GA4 purchase pushed', { transactionId, value: grossValue, currency });

                                        // Google Ads Conversion (optional; requires conversion label)
                                        try {
                                                                                        const convLabel = (typeof getGoogleConversionLabel === 'function') ? getGoogleConversionLabel() : (window.AW_CONVERSION_LABEL || '');
                                                                                        if (typeof gtag === 'function' && convLabel) {
                                                gtag('event', 'conversion', {
                                                                                                    'send_to': 'AW-17627402053/' + convLabel,
                                                  'value': grossValue,
                                                  'currency': currency,
                                                                                                    'transaction_id': transactionId
                                                });
                                                                                                adsDebug('Google Ads conversion fired', { convLabel, transactionId });
                                            }
                                        } catch(adErr){ console.warn('Ads conversion fire failed', adErr); }
                                        // Enhanced Conversions (attempt to push hashed email if consent granted)
                                        try {
                                            const consent = JSON.parse(localStorage.getItem('gb_consent_v1')||'null');
                                            const adsGranted = consent && consent.choices && ['ad_storage','ad_user_data'].some(k=>consent.choices[k]==='granted');
                                            if (adsGranted) {
                                                const email = paymentData.customer_email || (JSON.parse(localStorage.getItem('gb_current_user')||'null')?.email);
                                                if (email && typeof gtag === 'function') {
                                                    gtag('set','user_data', { email: email }); // gtag auto-hashes if enhanced conversions enabled
                                                }
                                            }
                                        } catch(ecErr){ console.warn('Enhanced conversions set failed', ecErr); }
                        } catch(e){ console.warn('GA4 purchase push failed', e); }

                        try {
                            if (typeof fbq === 'function') {
                                fbq('track', 'Purchase', {
                                    value: grossValue,
                                    currency: currency,
                                    contents: [{id: planKey, quantity:1}],
                                    content_type: 'coaching_plan'
                                }, { eventID: transactionId });
                                adsDebug('Meta Pixel purchase fired', { eventID: transactionId });
                                // Send fbp/fbc identifiers to backend for CAPI enrichment
                                try {
                                    const sessionId = paymentData.session_id || new URLSearchParams(window.location.search).get('session_id');
                                    const fbp = (document.cookie.match(/_fbp=([^;]+)/)||[])[1];
                                    // Build fbc if fbclid param present
                                    const fbclid = new URLSearchParams(window.location.search).get('fbclid');
                                    let fbc = null;
                                    if (fbclid) {
                                        const ts = Math.floor(Date.now()/1000);
                                        fbc = `fb.1.${ts}.${fbclid}`;
                                    }
                                    if (sessionId && (fbp || fbc)) {
                                        fetch('/api/attrib', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, fbp, fbc }) }).catch(()=>{});
                                        adsDebug('Meta attribution IDs sent to backend', { sessionId, fbp, fbc });
                                    }
                                } catch(metaErr){ console.warn('Meta attribution enrichment failed', metaErr); }
                            }
                        } catch(e){ console.warn('Pixel purchase failed', e); }

            // Configure Trainerize invite CTA
            try {
                const invite = paymentData.trainerize_invite || (document.querySelector('meta[name="trainerize:invite"]')?.getAttribute('content')) || '';
                const cta = document.getElementById('trainerize-cta');
                if (cta && invite) {
                    cta.href = invite;
                    cta.onclick = null;
                } else if (cta) {
                    cta.style.display = 'none';
                }
            } catch(e){ console.warn('Trainerize CTA config failed', e); }

            // Configure Booking CTA if provided via meta
            try {
                const booking = (document.querySelector('meta[name="booking:url"]')?.getAttribute('content')) || '';
                const book = document.getElementById('book-cta');
                if (book && booking) {
                    book.href = booking;
                } else if (book) {
                    book.style.display = 'none';
                }
            } catch(e){ console.warn('Booking CTA config failed', e); }
        }

        function showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            console.error('Payment verification error:', message);
        }

        // Google Ads Conversion Tracking Function
        function gtag_report_conversion(url) {
            var callback = function () {
                if (typeof(url) != 'undefined') {
                    window.location = url;
                }
            };
            gtag('event', 'conversion', {
                'send_to': 'AW-1762742053/mdOMCOTV3acbEWWes9VB',
                'value': 1.0,
                'currency': 'GBP',
                'event_callback': callback
            });
            return false;
        }
    </script>
    <!-- Navbar/Auth controller -->
    <script defer src="js/auth-guard.js?v=20251009"></script>
</body>
</html>
